

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% extends "base.html" %}
  <title>Design Personalizado</title>
  {% block content %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/design.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body class="design-page">
  {% include 'header.html' %}

  
  <div class="main-container">
    <!-- Barra lateral com ícones -->
    <div class="toolbar">
      <button class="toolbar-button">
        <i class="bi bi-tools"></i>
      </button>
      <button class="toolbar-button upload-button">
        <i class="bi bi-cloud-arrow-up"></i>
      </button>
      <div class="upload-toolbar-content" style="display: none;">
        <h3>Upload de Imagem</h3>
        <!-- Botão estilizado -->
        <label class="custom-file-upload">
          <input type="file" id="file-input" accept="image/*">
          Escolher arquivo
        </label>
        <!-- Galeria de imagens do usuário -->
        <div id="upload-gallery" class="gallery"></div>
      </div>
      <button class="toolbar-button">
        <i class="bi bi-palette"></i>
      </button>
      <button class="toolbar-button">
        <i class="bi bi-type"></i>
      </button>
    </div>
    <div class="vertical-line"></div>

    <!-- Contêiner do visualizador -->
    <div class="viewer-container">
      <!-- Nome e botão de edição -->
      <div class="title-container">
        <a d="design-name">{{ selecao['modelo'] or '(nome da peça)' }}</a>
        <button id="edit-button" class="icon-button">
          <i class="bi bi-pencil-fill"></i>
        </button>
      </div>

      <!-- Campo para edição do nome -->
      <input type="text" id="edit-name" value="{{ selecao['modelo'] or '' }}" class="edit-input" style="display: none;">
      <button id="save-button" class="save-button" style="display: none;">Salvar</button>

      <!-- Imagem do modelo -->
      <div id="model-viewer">
        <img src="{{ url_for('static', filename='models/' + imagem) }}" alt="{{ selecao['modelo'] or 'Peça' }}" class="viewer-image">
      </div>
    </div>
  </div>

  <!-- Popup para pré-visualização -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <h3>Pré-visualização da Imagem</h3>
      <img id="preview-image" src="" alt="Pré-visualização">
      <div class="popup-actions">
        <button id="confirm-upload" class="btn-confirm">Confirmar</button>
        <button id="cancel-upload" class="btn-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const uploadButton = document.querySelector(".upload-button");
      const toolbar = document.querySelector(".toolbar");
      const uploadContent = document.querySelector(".upload-toolbar-content");
      const galleryContainer = document.getElementById("upload-gallery");
      const fileInput = document.getElementById("file-input");
      const popup = document.getElementById("popup");
      const previewImage = document.getElementById("preview-image");
      const confirmButton = document.getElementById("confirm-upload");
      const cancelButton = document.getElementById("cancel-upload");
  
      let selectedFile = null;
  
      // Abre o popup ao selecionar o arquivo
      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          selectedFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImage.src = e.target.result;
            popup.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      });
  
      // Confirmar o upload
      confirmButton.addEventListener("click", async () => {
        if (selectedFile) {
          const formData = new FormData();
          formData.append("file", selectedFile);
  
          const response = await fetch("/upload/design", {
            method: "POST",
            body: formData,
          });
  
          const data = await response.json();
          if (data.success) {
            popup.classList.add("hidden");
            selectedFile = null;
  
            // Atualizar a galeria
            await loadUserDesignImages(data.image_url);
          } else {
            alert("Erro ao fazer upload: " + data.error);
          }
        }
      });
  
      // Cancelar o upload
      cancelButton.addEventListener("click", () => {
        popup.classList.add("hidden");
        selectedFile = null;
      });
  
      async function loadUserDesignImages(newImageUrl = null) {
  const images = [];

  // Se uma nova imagem for adicionada, insira-a na primeira posição do array
  if (newImageUrl) {
    images.push(newImageUrl);
  }

  // Fetch das imagens existentes
  const response = await fetch("/upload-img-data/design");
  const data = await response.json();

  if (data.success === false) {
    console.error("Erro ao carregar imagens:", data.error);
    return;
  }

  // Adicione as imagens existentes ao array (depois da nova imagem, se houver)
  images.push(...data.images);

  // Limpa a galeria antes de renderizar
  galleryContainer.innerHTML = "";

  // Adiciona as imagens à galeria, garantindo que as duas primeiras ocupem as colunas corretas
  images.forEach((image, index) => {
    const galleryItem = createGalleryItem(image);

    // Define a posição específica da primeira e segunda imagens
    if (index === 0) {
      galleryItem.style.gridColumn = "1"; // Primeira coluna
      galleryItem.style.gridRow = "1";   // Primeira linha
    } else if (index === 1) {
      galleryItem.style.gridColumn = "2"; // Segunda coluna
      galleryItem.style.gridRow = "1";   // Primeira linha
    }

    galleryContainer.appendChild(galleryItem);
  });
}

function createGalleryItem(imageUrl) {
  const imgElement = document.createElement("img");
  imgElement.src = imageUrl;
  imgElement.alt = "Imagem carregada";

  const itemDiv = document.createElement("div");
  itemDiv.classList.add("gallery-item");
  itemDiv.appendChild(imgElement);

  return itemDiv;
}


function reorderGallery() {
  const items = Array.from(document.querySelectorAll(".gallery-item"));
  const tempContainer = document.createElement("div");

  // Recria a galeria com base na ordem desejada
  items.forEach((item, index) => {
    tempContainer.appendChild(item);
  });

  galleryContainer.innerHTML = "";
  galleryContainer.append(...tempContainer.children);
}

      uploadButton.addEventListener("click", async () => {
        const isExpanded = toolbar.classList.toggle("expanded");
        uploadButton.classList.toggle("selected", isExpanded);
        uploadContent.style.display = isExpanded ? "flex" : "none";
        if (isExpanded) {
          await loadUserDesignImages();
        }
      });
  
      const editButton = document.getElementById("edit-button");
      const saveButton = document.getElementById("save-button");
      const designName = document.getElementById("design-name");
      const editNameInput = document.getElementById("edit-name");
  
      editButton.addEventListener("click", () => {
        editNameInput.style.display = "inline-block";
        saveButton.style.display = "inline-block";
        editButton.style.display = "none";
        designName.style.display = "none";
        editNameInput.focus();
      });
  
      saveButton.addEventListener("click", () => {
        const newName = editNameInput.value.trim();
        if (newName) {
          designName.textContent = newName;
          editNameInput.style.display = "none";
          saveButton.style.display = "none";
          editButton.style.display = "inline-block";
          designName.style.display = "inline-block";
        } else {
          alert("O nome não pode estar vazio.");
        }
      });
    });
  </script>
  {% endblock %}
</body>
</html>
